var ischool=ischool||{};ischool.WindowResizeHandler={};ischool.WindowResizeHandler.handle=function(h){var a=new Date(1,1,2E3,12,0,0),c=!1;$(window).resize(function(){a=new Date;!1===c&&(c=!0,setTimeout(g,200))});var g=function(){200>new Date-a?setTimeout(g,200):(c=!1,h&&h())}};ischool=ischool||{};ischool.CanvasResizer={};
ischool.CanvasResizer.handle=function(h){var a=h.containerID,c=h.afterResizedHandler,g=0,d=0;ischool.WindowResizeHandler.handle(function(){e()});var e=function(){g=$("#"+a).width()-3;d=$("#"+a).height()-3;var b=g,f=d;$("#"+a).html("");$("<canvas id='myCanvas' width='"+b+"' height='"+f+"' style='padding: 0px; margin: 0px; border: 0px; overflow: hidden;'></canvas>").appendTo("#"+a);c&&c()};e()};
$.fn.drawTouch=function(h){var a=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},h);return this.each(function(){var c=this.getContext("2d");c.lineWidth=a.lineWidth;var g=$(this).offset().left,d=$(this).offset().top,e=function(c){if(a.onEnd)a.onEnd()};$(this).on("touchstart",function(b){var f=b.originalEvent.changedTouches[0];c.beginPath();c.lineJoin="round";c.lineCap="round";b=Math.floor(f.pageX-g);f=Math.floor(f.pageY-d);c.moveTo(b,f);if(a.onStart)a.onStart();if(a.onDrawing)a.onDrawing({time:(new Date).getTime(),
x:b,y:f})});$(this).on("touchmove",function(b){var f=b.originalEvent.changedTouches[0];b.preventDefault();b=Math.floor(f.pageX-g);f=Math.floor(f.pageY-d);c.lineTo(b,f);c.strokeStyle=a.lineColor;c.stroke();if(a.onDrawing)a.onDrawing({time:(new Date).getTime(),x:b,y:f})});$(this).on("touchend",e);$(this).on("touchleave",e)})};
$.fn.drawMouse=function(h){var a=$.extend({onDrawing:null,onStart:null,onEnd:null,lineWidth:4,lineColor:"#000000"},h);return this.each(function(){var c=this.getContext("2d");c.lineWidth=a.lineWidth;var g=$(this).offset().left,d=$(this).offset().top,e=0,b=function(c){e=0;if(a.onEnd)a.onEnd()};$(this).on("mousedown",function(b){e=1;c.beginPath();c.lineJoin="round";c.lineCap="round";var k=Math.floor(b.pageX-g);b=Math.floor(b.pageY-d);c.moveTo(k,b);if(a.onStart)a.onStart();if(a.onDrawing)a.onDrawing({time:(new Date).getTime(),
x:k,y:b})});$(this).on("mousemove",function(b){if(e){var k=Math.floor(b.pageX-g);b=Math.floor(b.pageY-d);c.lineTo(k,b);c.strokeStyle=a.lineColor;c.stroke();if(a.onDrawing)a.onDrawing({time:(new Date).getTime(),x:k,y:b})}});$(this).on("mouseup",b);$(this).on("mouseout",b)})};ischool=ischool||{};ischool.StrokePlayer={};
ischool.StrokePlayer.create=function(h){var a=[],c=[],g=100,d=1,e;ischool.CanvasResizer.handle({containerID:h,widthDiff:0,heightDiff:0,afterResizedHandler:function(){f&&f();e&&e()}});var b=function(){for(var a=!1,b=0,b=0;b<c.length;b++)if(item=c[b],1==item.getStatus()){a=!0;break}if(!a)for(b=0;b<c.length;b++)if(item=c[b],0==item.getStatus()){item.draw(d,g);break}},f=function(){$(a).each(function(b,a){if(a&&0<a.points.length){var c=document.getElementById("myCanvas").getContext("2d");c.beginPath();
c.lineWidth=a.pen;c.strokeStyle=a.color;c.lineJoin="round";c.lineCap="round";var d=a.points[0];c.moveTo(d.x,d.y);$(a.points).each(function(a,b){c.lineTo(b.x,b.y);c.stroke()})}})};return{play:function(k,e,f){this.clean();this.stop();k&&(a=k,c=[],$(a).each(function(a,k){var d=StrokePainter("myCanvas",k,b);d&&c.push(d)}),f&&(g=f),e&&(d=e),b())},clean:function(){var a=document.getElementById("myCanvas");a.getContext("2d").clearRect(0,0,a.width,a.height)},drawNow:function(b){this.clean();a=b;f()},stop:function(){for(i=
0;i<c.length;i++)item=c[i],2!=item.getStatus()&&item.stop()},getStrokeCount:function(){return a.length},addStroke:function(d){a.push(d);0!=d.points.length&&((d=StrokePainter("myCanvas",d,b))&&c.push(d),b())},getCanvasID:function(){return"myCanvas"},setCanvasResizeHandler:function(a){e=a},setBackgroundImage:function(a){var b=$("#"+h);a.color&&b.css("background-color",a.color);a.imageUrl&&b.css("background-image","url("+a.imageUrl+")");a.repeat&&b.css("background-repeat",a.repeat);a.position&&b.css("background-position",
a.position);a.size&&b.css("background-size",a.size)},getImageDataUrl:function(){var a=document.getElementById("myCanvas");if(a)return a.toDataURL("image/png")}}};
var StrokePainter=function(h,a,c){if(!a||0==a.points.length)return null;var g=0,d,e=a.points,b=0,f=a.color,k=a.pen,l=e[0],n=l.time,m,r=1,s=100,p=!1,t=function(){g=1;m||(m=(new Date).getTime());d||(d=document.getElementById(h).getContext("2d"),d.beginPath(),d.lineWidth=k,d.strokeStyle=f,d.lineJoin="round",d.lineCap="round",d.moveTo(l.x,l.y));if(0!=e.length&&!(b>e.length-1)){for(var a=b,u=((new Date).getTime()-m)*r,a=b;a<e.length;a++){if(p){g=2;c&&c();return}var q=e[a];if(q.time-n<u)d.lineTo(q.x,q.y),
d.stroke();else break}a>=e.length?(g=2,c&&c()):(b=a,window.setTimeout(t,s))}};return{draw:function(a,b){r=a;s=b;p=!1;t()},getStatus:function(){return g},stop:function(){p=!0}}},ischool=ischool||{};ischool.Painter={};
ischool.Painter.create=function(h){var a=h.penSize,c=h.penColor,g=h.afterStroke,d=ischool.StrokePlayer.create(h.containerID);d.setCanvasResizeHandler(function(){l();n();d.drawNow(b)});var e=d.getCanvasID(),b=[],f=[],k=[],l=function(){$("#"+e).drawMouse({lineWidth:a,lineColor:c,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},onEnd:function(){var d={color:c,pen:a,points:k};b.push(d);f=[];g&&g(d)}})},n=function(){$("#"+e).drawTouch({lineWidth:a,lineColor:c,onStart:function(a){k=[]},onDrawing:function(a){k.push(a)},
onEnd:function(){var d={color:c,pen:a,points:k};b.push(d);f=[];g&&g(d)}})};l();n();var m=function(){$("#"+e).drawMouse({lineWidth:a,lineColor:c});$("#"+e).drawTouch({lineWidth:a,lineColor:c})};return{replay:function(a){d.play(b,a,10)},undo:function(){d.clean();var a=b.pop();a&&f.push(a);d.drawNow(b)},redo:function(){d.clean();var a=f.pop();a&&b.push(a);d.drawNow(b)},clean:function(){d.clean();b=[];f=[]},getStrokes:function(){return b},setStrokes:function(a){b=a},setPenColor:function(a){c=a;m()},setPenSize:function(b){a=
b;m()},getStrokePlayer:function(){return d},setBackgroundImage:function(a){d.setBackgroundImage(a)},getImageDataUrl:function(){return d.getImageDataUrl()}}};
